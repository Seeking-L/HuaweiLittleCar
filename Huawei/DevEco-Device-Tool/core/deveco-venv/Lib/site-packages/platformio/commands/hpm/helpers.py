#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2021-2021. All rights reserved.
Description: Decorator for hpm install,
            You can set the number of retries if you encounter network problems.
Create: 2022-11-24
"""

import time
from functools import wraps, partial

import click


def retry(times=3, delay=10, exceptions=Exception):
    """
    :times: Number of retries of the decorated function,The default retry times are 3.
    :delay: Retry Interval
    :exceptions: Exceptions of Decorated Functions
    """

    def _inter_retry(caller, retry_time, retry_delay, ex):
        while retry_time:
            try:
                return caller()
            except ex as e:
                retry_time -= 1
                if not retry_time:
                    click.echo("Installation error. Please check your network or proxy before restarting vscode.")
                    raise
                click.echo(f"An error occurred during installation, Retrying..., Retry times remainingï¼š{retry_time}")
                time.sleep(retry_delay)

    def retry_decorator(func):
        @wraps(func)
        def _wraps(*args, **kwargs):
            # partial: Fixes some parameters(*args, **kwargs) of a function and returns a new function.
            return _inter_retry(partial(func, *args, **kwargs), times, delay, exceptions)

        return _wraps

    return retry_decorator
