#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
Copyright (c) Huawei Technologies Co., Ltd. 2021-2022. All rights reserved.
Description: encrypt and decrypt adapt for device tool module
Create: 2022-05-08
"""
import os
import shutil
import stat

from platformio.security.cryptor_kit import CryptorKit
from platformio.security.key_manager import KeyManager
from platformio.helpers import get_config_json_path

MATERIAL_PATH = get_config_json_path()


def encrypt_msg(plaintxt):
    """
    @param plaintxt: input string to encrypt
    @return:
    """
    key_manager = KeyManager('remote')
    key = key_manager.read_or_create_key(MATERIAL_PATH)

    cryptor = CryptorKit()
    return cryptor.encrypt(key, bytes(plaintxt, encoding='utf-8'))


def remove_readonly(func, path, _):
    os.chmod(path, stat.S_IWRITE)
    func(path)


def decrypt_msg(encrypted_msg):
    """
    @param encrypted_msg: encrypted msg
    @return:
    """
    key_manager = KeyManager('remote')
    key = key_manager.read_or_create_key(MATERIAL_PATH)

    deyptor = CryptorKit()
    decrypte_msg = deyptor.decrypt(key, encrypted_msg)
    shutil.rmtree(
        os.path.join(
            MATERIAL_PATH,
            'security'),
        onerror=remove_readonly)
    return str(decrypte_msg, encoding='utf-8')
